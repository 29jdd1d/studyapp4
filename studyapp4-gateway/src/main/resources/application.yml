server:
  port: 8088

spring:
  jmx:
    enabled: false
  application:
    name: studyapp4-gateway
  cloud:
    nacos:
      username: nacos
      password: nacos
      discovery:
        server-addr: localhost:8848
        namespace: dev
      config:
        server-addr: localhost:8848
        namespace: dev
        file-extension: yml
        refresh-enabled: true
    gateway:
      routes:
        # ========== Knife4j API文档路由 ==========
        # 用户服务文档
        - id: user-doc
          uri: lb://studyapp4-user
          predicates:
            - Path=/user/doc.html,/user/swagger-resources/**,/user/v3/api-docs/**,/user/webjars/**
          filters:
            - StripPrefix=1
        
        # 资源服务文档
        - id: resource-doc
          uri: lb://studyapp4-resource
          predicates:
            - Path=/resource/doc.html,/resource/swagger-resources/**,/resource/v3/api-docs/**,/resource/webjars/**
          filters:
            - StripPrefix=1
        
        # 学习计划服务文档
        - id: plan-doc
          uri: lb://studyapp4-plan
          predicates:
            - Path=/plan/doc.html,/plan/swagger-resources/**,/plan/v3/api-docs/**,/plan/webjars/**
          filters:
            - StripPrefix=1
        
        # 考试服务文档
        - id: exam-doc
          uri: lb://studyapp4-exam
          predicates:
            - Path=/exam/doc.html,/exam/swagger-resources/**,/exam/v3/api-docs/**,/exam/webjars/**
          filters:
            - StripPrefix=1
        
        # 社区服务文档
        - id: community-doc
          uri: lb://studyapp4-community
          predicates:
            - Path=/community/doc.html,/community/swagger-resources/**,/community/v3/api-docs/**,/community/webjars/**
          filters:
            - StripPrefix=1
        
        # 后台管理服务文档
        - id: admin-doc
          uri: lb://studyapp4-admin
          predicates:
            - Path=/admin/doc.html,/admin/swagger-resources/**,/admin/v3/api-docs/**,/admin/webjars/**
          filters:
            - StripPrefix=1
        
        # ========== 业务API路由 ==========
        # 用户服务路由
        - id: studyapp4-user
          uri: lb://studyapp4-user
          predicates:
            - Path=/api/v1/user/**
          filters:
            - StripPrefix=0
        
        # 资源服务路由
        - id: studyapp4-resource
          uri: lb://studyapp4-resource
          predicates:
            - Path=/api/v1/resource/**
          filters:
            - StripPrefix=0
        
        # 学习计划服务路由
        - id: studyapp4-plan
          uri: lb://studyapp4-plan
          predicates:
            - Path=/api/v1/plan/**
          filters:
            - StripPrefix=0
        
        # 题库服务路由
        - id: studyapp4-exam
          uri: lb://studyapp4-exam
          predicates:
            - Path=/api/v1/exam/**
          filters:
            - StripPrefix=0
        
        # 社区服务路由
        - id: studyapp4-community
          uri: lb://studyapp4-community
          predicates:
            - Path=/api/v1/community/**
          filters:
            - StripPrefix=0
        
        # 后台管理服务路由
        - id: studyapp4-admin
          uri: lb://studyapp4-admin
          predicates:
            - Path=/api/v1/admin/**
          filters:
            - StripPrefix=0
      
      # 全局 CORS 配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origin-patterns: "*"  # 改用 patterns 支持凭证
            allowed-methods: "*"
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600
      
      # 默认过滤器
      default-filters:
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
            methods: GET,POST

# JWT 配置
jwt:
  secret: studyapp4-jwt-secret-key-2025-kaoyan-learning-platform

# 不需要鉴权的路径（逗号分隔）
auth:
  exclude-paths: /api/v1/user/wx-login,/api/v1/user/register,/api/v1/community/posts/list,/api/v1/resource/public/**,/user/**,/resource/**,/plan/**,/exam/**,/community/**,/admin/**,/health

logging:
  level:
    org.springframework.cloud.gateway: DEBUG
